---
- name: Configure OpenClaw
  hosts: openclaws
  become: true
  gather_facts: true

  tasks:
    - name: Install prerequisites for repository setup
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Configure APT repositories (deb822 format)
      ansible.builtin.deb822_repository:
        name: "{{ item.name }}"
        types: "{{ item.types | default(['deb']) }}"
        uris: "{{ item.uris }}"
        suites: "{{ item.suites }}"
        components: "{{ item.components | default(omit) }}"
        architectures: "{{ item.architectures | default(omit) }}"
        signed_by: "{{ item.signed_by }}"
        state: present
        enabled: true
      loop: "{{ apt_repos }}"

    - name: Add PPA repositories
      ansible.builtin.apt_repository:
        repo: "{{ item }}"
        state: present
      loop: "{{ ppa_repos }}"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Install unattended-upgrades (security updates)
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present

    - name: Apply apt security updates
      ansible.builtin.command: unattended-upgrade
      register: unattended_upgrade_result
      when: not ansible_check_mode
      changed_when: false

    - name: Install base packages
      ansible.builtin.apt:
        name: "{{ base_packages }}"
        state: present

    - name: Install QEMU guest agent
      ansible.builtin.apt:
        name: qemu-guest-agent
        state: present

    - name: Ensure QEMU guest agent is enabled and started
      ansible.builtin.systemd:
        name: qemu-guest-agent
        enabled: true
        state: started

    - name: Install third-party packages
      ansible.builtin.apt:
        name: "{{ third_party_packages }}"
        state: present

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ target_user }}"
        groups: docker
        append: true
      # Note: docker group is created by the Docker package installed above

    - name: Install OpenSSH server (Remote Login)
      ansible.builtin.apt:
        name: openssh-server
        state: present

    - name: Enable and start SSH service
      ansible.builtin.systemd:
        name: ssh
        enabled: true
        state: started

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "{{ target_user_home }}/.ssh"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0700"

    - name: Add authorized SSH key
      ansible.posix.authorized_key:
        user: "{{ target_user }}"
        key: "{{ ssh_public_key }}"
        state: present

    - name: Disable SSH password authentication
      ansible.builtin.copy:
        dest: /etc/ssh/sshd_config.d/99-keys-only.conf
        content: |
          PasswordAuthentication no
          PubkeyAuthentication yes
        mode: "0644"
      notify: Restart SSH

    - name: NoMachine
      block:
        - name: Check if NoMachine is running
          ansible.builtin.systemd:
            name: nxserver.service
          register: nxserver_status
          failed_when: false

        - name: Download NoMachine
          ansible.builtin.get_url:
            url: "{{ nomachine_deb_url }}"
            dest: "{{ nomachine_deb_path }}"
            mode: "0644"
          when:
            - not ansible_check_mode
            - nxserver_status.status.ActiveState | default('') != 'active'

        - name: Install NoMachine
          ansible.builtin.apt:
            deb: "{{ nomachine_deb_path }}"
            state: present
          when:
            - not ansible_check_mode
            - nxserver_status.status.ActiveState | default('') != 'active'

        - name: Allow Nomachine
          community.general.ufw:
            rule: allow
            proto: tcp
            port: "4000"

    - name: Obsidian
      block:
        - name: Ensure ~/bin exists for Obsidian AppImage
          ansible.builtin.file:
            path: "{{ target_user_home }}/bin"
            state: directory
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0755"

        - name: Download Obsidian AppImage
          ansible.builtin.get_url:
            url: "{{ obsidian_appimage_url }}"
            dest: "{{ obsidian_appimage_path }}"
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0755"
          when: not ansible_check_mode

        - name: Create Obsidian AppImage symlink
          ansible.builtin.file:
            src: "{{ obsidian_appimage_path }}"
            dest: "{{ obsidian_appimage_link }}"
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            force: true
            state: link

    - name: Install snap-store
      community.general.snap:
        name: snap-store
        state: present

    - name: Install snap packages
      community.general.snap:
        name: "{{ snap_packages }}"
        state: present
      when: snap_packages | length > 0

    - name: Install snap packages (classic confinement)
      community.general.snap:
        name: "{{ snap_classic_packages }}"
        classic: true
        state: present
      when: snap_classic_packages | length > 0

    - name: Homebrew
      block:
        - name: Ensure Homebrew prefix directories exist
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0755"
          loop:
            - /home/linuxbrew
            - "{{ brew_prefix }}"

        - name: Install Homebrew
          become: true
          become_user: "{{ target_user }}"
          ansible.builtin.shell: |
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          args:
            creates: "{{ brew_prefix }}/bin/brew"

        - name: Add Homebrew to bashrc
          ansible.builtin.lineinfile:
            path: "{{ target_user_home }}/.bashrc"
            line: 'eval "$({{ brew_prefix }}/bin/brew shellenv)"'
            create: true
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0644"

        - name: Install Homebrew packages
          become: true
          become_user: "{{ target_user }}"
          community.general.homebrew:
            name: "{{ brew_packages }}"
            state: present
            path: "{{ brew_prefix }}/bin"

    - name: Mise
      block:
        - name: Install mise
          become: true
          become_user: "{{ target_user }}"
          ansible.builtin.shell: |
            curl -fsSL https://mise.run | sh
          args:
            creates: "{{ target_user_home }}/.local/bin/mise"

        - name: Add mise to bashrc
          ansible.builtin.lineinfile:
            path: "{{ target_user_home }}/.bashrc"
            line: 'eval "$({{ target_user_home }}/.local/bin/mise activate bash)"'
            create: true
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0644"

    - name: Configure user environment variables
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.blockinfile:
        path: "{{ target_user_home }}/.bashrc"
        create: true
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"
        marker: "# {mark} ANSIBLE OPENCLAW ENV"
        block: |
          {% for item in env_vars | dictsort %}
          export {{ item.0 }}={{ item.1 }}
          {% endfor %}
      when: env_vars | length > 0

    - name: Source user bashrc for this task session
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        source "{{ target_user_home }}/.bashrc"
      args:
        executable: /bin/bash
      changed_when: false
      when: env_vars | length > 0

    - name: Install mise tools
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        eval "$({{ target_user_home }}/.local/bin/mise activate bash)"
        mise install {{ item }}
        mise use -g {{ item }}
      args:
        executable: /bin/bash
      loop: "{{ mise_tools }}"
      register: mise_result
      changed_when: "'installed' in mise_result.stdout"

    - name: Install Claude CLI
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        curl -fsSL https://claude.ai/install.sh | bash
      args:
        creates: "{{ target_user_home }}/.claude/local/bin/claude"

    - name: Install Cursor CLI
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        curl -fsSL https://cursor.com/install | bash
      args:
        creates: "{{ target_user_home }}/.local/bin/agent"

    # -- NPM Packages ---
    - name: Install global npm packages
      become: true
      become_user: "{{ target_user }}"
      community.general.npm:
        name: "{{ item }}"
        global: true
        state: present
      environment:
        PATH: "{{ target_user_home }}/.local/share/mise/shims:{{ target_user_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
      loop: "{{ npm_global_packages }}"

    - name: Update openclaw to latest
      become: true
      become_user: "{{ target_user }}"
      community.general.npm:
        name: "openclaw@latest"
        global: true
        state: latest
      environment:
        PATH: "{{ target_user_home }}/.local/share/mise/shims:{{ target_user_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
      register: openclaw_update

    - name: Restart openclaw gateway
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.command: openclaw gateway restart
      environment:
        PATH: "{{ target_user_home }}/.local/share/mise/shims:{{ target_user_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
      when: openclaw_update.changed

    # -- Bun global packages ---
    - name: Install global Bun packages
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        eval "$({{ target_user_home }}/.local/bin/mise activate bash)"
        bun install -g {{ item | quote }}
      args:
        executable: /bin/bash
      environment:
        PATH: "{{ target_user_home }}/.local/share/mise/shims:{{ target_user_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
      loop: "{{ bun_global_packages }}"
      when: bun_global_packages | length > 0

    - name: Tailscale
      block:
        - name: Install Tailscale
          ansible.builtin.shell: |
            curl -fsSL https://tailscale.com/install.sh | sh
          args:
            creates: /usr/bin/tailscale

        - name: Configure Tailscale (optional)
          ansible.builtin.command:
            argv: >-
              {{
                ['tailscale', 'up', '--authkey=' ~ tailscale_authkey]
                + (['--operator=' ~ tailscale_operator_user] if tailscale_operator_user | length > 0 else [])
                + (['--hostname=' ~ tailscale_hostname] if tailscale_hostname | length > 0 else [])
                + (tailscale_up_extra_args.split() if tailscale_up_extra_args | length > 0 else [])
              }}
          when: tailscale_authkey | length > 0
          register: tailscale_up
          changed_when: "'Success' in tailscale_up.stdout or 'Success' in tailscale_up.stderr or tailscale_up.rc == 0"

    - name: Caddy & PHP
      block:
        - name: Ensure Caddyfile configuration exists
          ansible.builtin.copy:
            dest: /etc/caddy/Caddyfile
            content: |
              :80 {
                  root * /var/www/html
                  php_fastcgi unix//run/php/php-fpm.sock
                  file_server
              }
            mode: "0644"
          notify: Restart Caddy

        - name: Ensure web root exists
          ansible.builtin.file:
            path: /var/www/html
            state: directory
            owner: www-data
            group: www-data
            mode: "0755"

        - name: Create hello world index.php
          ansible.builtin.copy:
            dest: /var/www/html/index.php
            content: "<?php echo 'Hello World'; ?>"
            owner: www-data
            group: www-data
            mode: "0644"

        - name: Enable and start Caddy
          ansible.builtin.systemd:
            name: caddy
            enabled: true
            state: started

        - name: Run tailscale serve
          ansible.builtin.command: tailscale serve --bg 80
          when: not ansible_check_mode
          changed_when: false

    - name: Set Default Browser
      block:
        # CLI default (what /usr/bin/x-www-browser points to)
        - name: Set x-www-browser to Chrome
          community.general.alternatives:
            name: x-www-browser
            path: /usr/bin/google-chrome-stable
          when: ansible_facts.os_family == "Debian"

        # Desktop default (GNOME, per-user). Run as the target desktop user, not root.
        - name: Set default browser for GNOME (per-user)
          become: false
          vars:
            desktop_user: "{{ ansible_facts['user_id'] }}"
          ansible.builtin.command: >
            xdg-settings set default-web-browser google-chrome.desktop
          environment:
            DISPLAY: ":0"
            XDG_RUNTIME_DIR: "/run/user/{{ lookup('ansible.builtin.pipe', 'id -u ' ~ desktop_user) }}"
          changed_when: false

        # MIME associations (covers http/https in most desktops)
        - name: Ensure Chrome is default for http/https (per-user)
          become: false
          ansible.builtin.shell: |
            set -euo pipefail
            mkdir -p ~/.config
            if command -v xdg-mime >/dev/null 2>&1; then
              xdg-mime default google-chrome.desktop x-scheme-handler/http
              xdg-mime default google-chrome.desktop x-scheme-handler/https
            fi
          args:
            executable: /bin/bash
          changed_when: false

    - name: Enable serial console for Proxmox xterm.js
      ansible.builtin.systemd:
        name: serial-getty@ttyS0.service
        enabled: true
        state: started

    - name: Setup local cron job
      ansible.builtin.cron:
        name: "hello world cron"
        job: "echo 'hello world'"
        minute: "*"
        user: "{{ target_user }}"

    - name: Allow SSH from
      community.general.ufw:
        rule: allow
        proto: tcp
        port: "22"

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted
    - name: Restart Caddy
      ansible.builtin.systemd:
        name: caddy
        state: restarted
