---
- name: Configure Ubuntu Workstation
  hosts: workstations
  become: true
  gather_facts: true

  tasks:
    # --- Prerequisites (needed for repo setup) ---
    - name: Install prerequisites for repository setup
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Configure APT repositories (deb822 format)
      ansible.builtin.deb822_repository:
        name: "{{ item.name }}"
        types: "{{ item.types | default(['deb']) }}"
        uris: "{{ item.uris }}"
        suites: "{{ item.suites }}"
        components: "{{ item.components | default(omit) }}"
        architectures: "{{ item.architectures | default(omit) }}"
        signed_by: "{{ item.signed_by }}"
        state: present
        enabled: true
      loop: "{{ apt_repos }}"

    - name: Ensure 1Password debsig policy directory exists
      ansible.builtin.file:
        path: /etc/debsig/policies/AC2D62742012EA22
        state: directory
        mode: "0755"
      when: apt_repos | selectattr('name', 'equalto', '1password') | list | length > 0

    - name: Install 1Password debsig policy
      ansible.builtin.get_url:
        url: https://downloads.1password.com/linux/debian/debsig/1password.pol
        dest: /etc/debsig/policies/AC2D62742012EA22/1password.pol
        mode: "0644"
      when: apt_repos | selectattr('name', 'equalto', '1password') | list | length > 0

    - name: Ensure 1Password debsig keyring directory exists
      ansible.builtin.file:
        path: /usr/share/debsig/keyrings/AC2D62742012EA22
        state: directory
        mode: "0755"
      when: apt_repos | selectattr('name', 'equalto', '1password') | list | length > 0

    - name: Install 1Password debsig key
      ansible.builtin.shell: |
        set -euo pipefail
        curl -fsSL https://downloads.1password.com/linux/keys/1password.asc | gpg --dearmor --batch --yes -o /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
      args:
        executable: /bin/bash
        creates: /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
      when: apt_repos | selectattr('name', 'equalto', '1password') | list | length > 0

    # --- APT Packages ---
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Install unattended-upgrades (security updates)
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present

    - name: Apply apt security updates
      ansible.builtin.command: unattended-upgrade
      register: unattended_upgrade_result
      when: not ansible_check_mode
      changed_when: false

    - name: Install base packages
      ansible.builtin.apt:
        name: "{{ base_packages }}"
        state: present

    - name: Install third-party packages
      ansible.builtin.apt:
        name: "{{ third_party_packages }}"
        state: present

    - name: Install Docker packages
      ansible.builtin.apt:
        name: "{{ docker_ce_packages }}"
        state: present

    # --- Docker ---
    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ target_user }}"
        groups: docker
        append: true
      # Note: docker group is created by the Docker package installed above

    # --- SSH ---
    - name: Install OpenSSH server (Remote Login)
      ansible.builtin.apt:
        name: openssh-server
        state: present

    - name: Enable and start SSH service
      ansible.builtin.systemd:
        name: ssh
        enabled: true
        state: started

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "{{ target_user_home }}/.ssh"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0700"

    - name: Add authorized SSH key
      ansible.posix.authorized_key:
        user: "{{ target_user }}"
        key: "{{ ssh_public_key }}"
        state: present

    - name: Disable SSH password authentication
      ansible.builtin.copy:
        dest: /etc/ssh/sshd_config.d/99-keys-only.conf
        content: |
          PasswordAuthentication no
          PubkeyAuthentication yes
        mode: "0644"
      notify: Restart SSH

    # --- NoMachine ---
    - name: NoMachine
      block:
        - name: Check if NoMachine is running
          ansible.builtin.systemd:
            name: nxserver.service
          register: nxserver_status
          failed_when: false

        - name: Download NoMachine
          ansible.builtin.get_url:
            url: "{{ nomachine_deb_url }}"
            dest: "{{ nomachine_deb_path }}"
            mode: "0644"
          when:
            - not ansible_check_mode
            - nxserver_status.status.ActiveState | default('') != 'active'

        - name: Install NoMachine
          ansible.builtin.apt:
            deb: "{{ nomachine_deb_path }}"
            state: present
          when:
            - not ansible_check_mode
            - nxserver_status.status.ActiveState | default('') != 'active'

    # --- Snap ---
    - name: Install snap-store
      community.general.snap:
        name: snap-store
        state: present

    # --- User Tools (Homebrew) ---
    - name: Ensure Homebrew prefix directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"
      loop:
        - /home/linuxbrew
        - "{{ brew_prefix }}"

    - name: Install Homebrew
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: "{{ brew_prefix }}/bin/brew"

    - name: Add Homebrew to bashrc
      ansible.builtin.lineinfile:
        path: "{{ target_user_home }}/.bashrc"
        line: 'eval "$({{ brew_prefix }}/bin/brew shellenv)"'
        create: true
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"

    - name: Install Homebrew packages
      become: true
      become_user: "{{ target_user }}"
      community.general.homebrew:
        name: "{{ brew_packages }}"
        state: present
        path: "{{ brew_prefix }}/bin"

    # --- User Tools (mise) ---
    - name: Install mise
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        curl -fsSL https://mise.run | sh
      args:
        creates: "{{ target_user_home }}/.local/bin/mise"

    - name: Add mise to bashrc
      ansible.builtin.lineinfile:
        path: "{{ target_user_home }}/.bashrc"
        line: 'eval "$({{ target_user_home }}/.local/bin/mise activate bash)"'
        create: true
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"

    - name: Install mise tools
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        eval "$({{ target_user_home }}/.local/bin/mise activate bash)"
        mise install {{ item }}
        mise use -g {{ item }}
      args:
        executable: /bin/bash
      loop: "{{ mise_tools }}"
      register: mise_result
      changed_when: "'installed' in mise_result.stdout"

    # --- Agent CLIs ---
    - name: Install Claude CLI
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        curl -fsSL https://claude.ai/install.sh | bash
      args:
        creates: "{{ target_user_home }}/.claude/local/bin/claude"

    - name: Install Gemini CLI via npm
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        eval "$({{ target_user_home }}/.local/bin/mise activate bash)"
        npm install -g @google/gemini-cli
      environment:
        npm_config_prefix: "{{ target_user_home }}/.local"
      args:
        executable: /bin/bash
        creates: "{{ target_user_home }}/.local/bin/gemini"

    - name: Install OpenCode
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        curl -fsSL https://opencode.ai/install | bash
      args:
        creates: "{{ target_user_home }}/.local/bin/opencode"

    - name: Install Codex CLI via npm
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell: |
        eval "$({{ target_user_home }}/.local/bin/mise activate bash)"
        npm install -g @openai/codex
      environment:
        npm_config_prefix: "{{ target_user_home }}/.local"
      args:
        executable: /bin/bash
        creates: "{{ target_user_home }}/.local/bin/codex"

    # --- Tailscale ---
    - name: Tailscale
      block:
        - name: Install Tailscale
          ansible.builtin.shell: |
            curl -fsSL https://tailscale.com/install.sh | sh
          args:
            creates: /usr/bin/tailscale

        - name: Configure Tailscale (optional)
          ansible.builtin.command:
            argv: >-
              {{
                ['tailscale', 'up', '--authkey=' ~ tailscale_authkey]
                + (['--operator=' ~ tailscale_operator_user] if tailscale_operator_user | length > 0 else [])
                + (['--hostname=' ~ tailscale_hostname] if tailscale_hostname | length > 0 else [])
                + (tailscale_up_extra_args.split() if tailscale_up_extra_args | length > 0 else [])
              }}
          when: tailscale_authkey | length > 0
          register: tailscale_up
          changed_when: "'Success' in tailscale_up.stdout or 'Success' in tailscale_up.stderr or tailscale_up.rc == 0"

    # CLI default (what /usr/bin/x-www-browser points to)
    - name: Set x-www-browser to Chrome
      community.general.alternatives:
        name: x-www-browser
        path: /usr/bin/google-chrome-stable
      when: ansible_facts.os_family == "Debian"

    # Desktop default (GNOME, per-user). Run as the target desktop user, not root.
    - name: Set default browser for GNOME (per-user)
      become: false
      vars:
        desktop_user: "{{ ansible_facts['user_id'] }}"
      ansible.builtin.command: >
        xdg-settings set default-web-browser google-chrome.desktop
      environment:
        DISPLAY: ":0"
        XDG_RUNTIME_DIR: "/run/user/{{ lookup('ansible.builtin.pipe', 'id -u ' ~ desktop_user) }}"
      changed_when: false

    # MIME associations (covers http/https in most desktops)
    - name: Ensure Chrome is default for http/https (per-user)
      become: false
      ansible.builtin.shell: |
        set -euo pipefail
        mkdir -p ~/.config
        if command -v xdg-mime >/dev/null 2>&1; then
          xdg-mime default google-chrome.desktop x-scheme-handler/http
          xdg-mime default google-chrome.desktop x-scheme-handler/https
        fi
      args:
        executable: /bin/bash
      changed_when: false

    # --- Remote Desktop ---
    - name: Remote Desktop
      block:
        - name: Install GNOME Remote Desktop + winpr-utils (system RDP)
          ansible.builtin.apt:
            name:
              - gnome-remote-desktop
              - winpr-utils
            state: present
            update_cache: true

        - name: Reload systemd units (in case packages updated unit files)
          ansible.builtin.command: systemctl daemon-reload
          changed_when: false

        - name: Ensure gnome-remote-desktop TLS directory exists
          ansible.builtin.file:
            path: /var/lib/gnome-remote-desktop/.local/share/gnome-remote-desktop
            state: directory
            owner: gnome-remote-desktop
            group: gnome-remote-desktop
            mode: "0700"

        - name: Generate system RDP TLS cert/key (winpr-makecert)
          become: true
          become_user: gnome-remote-desktop
          ansible.builtin.command:
            argv:
              - winpr-makecert
              - -silent
              - -rdp
              - -path
              - /var/lib/gnome-remote-desktop/.local/share/gnome-remote-desktop
              - tls
          args:
            creates: /var/lib/gnome-remote-desktop/.local/share/gnome-remote-desktop/tls.key
          changed_when: true

        - name: Configure system RDP TLS key
          ansible.builtin.command:
            argv:
              - grdctl
              - --system
              - rdp
              - set-tls-key
              - /var/lib/gnome-remote-desktop/.local/share/gnome-remote-desktop/tls.key
          changed_when: true

        - name: Configure system RDP TLS cert
          ansible.builtin.command:
            argv:
              - grdctl
              - --system
              - rdp
              - set-tls-cert
              - /var/lib/gnome-remote-desktop/.local/share/gnome-remote-desktop/tls.crt
          changed_when: true

        - name: Set system RDP gate credentials (required for remote login)
          ansible.builtin.command:
            argv:
              - grdctl
              - --system
              - rdp
              - set-credentials
              - "{{ system_rdp_user }}"
              - "{{ system_rdp_password }}"
          when: system_rdp_password | length > 0
          no_log: true
          changed_when: true

        - name: Enable system RDP (GDM remote login)
          ansible.builtin.command: grdctl --system rdp enable
          changed_when: true

        - name: Check grdctl RDP subcommands
          ansible.builtin.command: grdctl --system rdp --help
          register: grdctl_rdp_help
          changed_when: false
          failed_when: false

        - name: Allow remote control over RDP (not view-only) when supported
          become: true
          ansible.builtin.command: grdctl --system rdp disable-view-only
          when: >-
            (grdctl_rdp_help.stdout is search("disable-view-only")) or
            (grdctl_rdp_help.stderr is search("disable-view-only"))
          changed_when: false
          failed_when: false

        - name: Ensure GNOME Remote Desktop is enabled and started
          ansible.builtin.systemd:
            name: "{{ item }}"
            enabled: true
            state: restarted
          loop:
            - gnome-remote-desktop

        - name: Ensure graphical target is default
          ansible.builtin.command: systemctl set-default graphical.target
          changed_when: false

        - name: Allow RDP
          community.general.ufw:
            rule: allow
            proto: tcp
            port: "3389"

    - name: Allow SSH from
      community.general.ufw:
        rule: allow
        proto: tcp
        port: "22"

    - name: Allow Nomachine
      community.general.ufw:
        rule: allow
        proto: tcp
        port: "4000"

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted
